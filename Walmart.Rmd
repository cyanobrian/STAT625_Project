---
title: "STAT625_Project"
author: "Brian Zhang, Vi Mai, Xinyu Zhou (Anna), Ziyan Zhao"
date: "`r Sys.Date()`"
output: pdf_document
---
```{r}
library(lmerTest)
library(ggplot2)
rm(list = ls())
walmart <- read.csv("Walmart.csv")
head(walmart)
```

### Data Preprocessing 

Since dates are strings, they must be converted to parsed and converted to days. Use days since the first day rather than the actual date to make computation easier. 
```{r}
# Convert the dates from character strings into days since the first date 
asDate_result <- as.Date(walmart$Date, "%d-%m-%Y")
first_date <- min(asDate_result)
days_elapsed <- asDate_result-first_date
walmart["Days_since"] <- days_elapsed
head(walmart)
```

### Initial Diagnostic Plots 
```{r}
# Comparing the need for a log transformation on Weekly Sales 
full_mod_no_log <- lm(Weekly_Sales ~ Days_since + Unemployment + CPI + Fuel_Price + Temperature + Holiday_Flag, data = walmart)
plot(full_mod_no_log,
     col = rgb(red = 0, green = 0, blue = 0, alpha = 0.25), 
     pch = 16
)

full_mod_w_log <- lm(log(Weekly_Sales) ~ Days_since + Unemployment + CPI + Fuel_Price + Temperature + Holiday_Flag, data = walmart)
plot(full_mod_w_log,
     col = rgb(red = 0, green = 0, blue = 0, alpha = 0.25), 
     pch = 16
)
```

```{r}
# Fit a mixed model, look at residual plots
mixed_effect_mod <- lmer(Weekly_Sales ~ (1|Store) + Days_since + Unemployment + CPI + Fuel_Price + Temperature + Holiday_Flag, data=walmart)
plot(mixed_effect_mod)

mixed_effect_mod_log <- lmer(log(Weekly_Sales) ~ (1|Store) + Days_since + Unemployment + CPI + Fuel_Price + Temperature + Holiday_Flag, data=walmart)
plot(mixed_effect_mod_log)

mixed_effect_mod_sqrt<- lmer(sqrt(Weekly_Sales) ~ (1|Store) + Days_since + Unemployment + CPI + Fuel_Price + Temperature + Holiday_Flag, data=walmart)
plot(mixed_effect_mod_sqrt)
```

No transformation on Weekly Sales and sqrt(Weekly Sales) show a megaphone effect, nonconstant variance. However, the log transformation on Weekly Sales seems to get rid of the megaphone appearance of the residuals, indicating constant variance. Thus, the log transformation may be the most appropriate. 

```{r}
# QQ plots for different models 
qqPlot(residuals(full_mod_no_log))
qqPlot(residuals(full_mod_w_log))
qqPlot(residuals(mixed_effect_mod))
qqPlot(residuals(mixed_effect_mod_log))
```

The full model without the log transform shows residuals that are most close to a normal distribution. However, all show deviations at lower normal quantiles and higher normal quantiles. When comparing the mixed effect on store on log(Weekly Sales) versus a mixed effect on store on Weekly Sales, the one with the log transformation appears to be more close to a normal distribution. 



### Scatterplot with variabels vs log(Weekly_Sales)
```{r}
# Looking at effect of Days and Store on log(Weekly Sales)
plot(log(Weekly_Sales) ~ Days_since + Store + Temperature + Unemployment + CPI + Fuel_Price + Temperature + Holiday_Flag, data = walmart, 
     col = alpha(walmart$Store, 0.5),  # makes color dependent on store 
     pch = 16,
     cex = 0.6)
```

```{r}
# Scatterplot matrix - uninterprettable
pairs(Weekly_Sales ~ Days_since + Unemployment + CPI + Fuel_Price + Temperature + Holiday_Flag, data = walmart)
```